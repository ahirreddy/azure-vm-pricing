# Azure VM pricing

Mass-pricing of `VMs` on `Azure` based on `CPU` cores count and memory. This is useful when costing a lift-and-shift migration dealing with many thousands `VMS` of varied sizes.

The pricing is retrieved from [Virtual Machines Pricing][virtual-machines-pricing].

:rotating_light: This tool will only provide you with an **estimation**. Depending on your `Azure` spends you might be able to get a better deal from `Microsoft`. You should use the output of this tool as a coarse-grain estimation. On top of the `VM` price you will also need to consider [storage][managed-disks-pricing] and [egress][bandwidth-pricing-details] costs.

This tool is composed of two components:

1. A [Parser](#parser) retrieving the pricing from [Virtual Machines Pricing][virtual-machines-pricing]
2. A [Coster](#coster) using the output from the `Parser` and a list of `VMs` specifications to establish their price

This approach allows to decouple pricing acquisition from its usage and open the door to automation. The `Parser` can be scheduled to retrieve the pricing at regular interval and the `Coster` can then use an always up-to-date pricing.

## Parser

Retrieve `VMs` **hourly** pricing for a specific **culture**, **currency**, **operating system** and **region**.

### Parser pre-requisites

- `Node.js 8.12`
- `Yarn 1.13.0`

```posh
λ  cd .\parser\
λ  yarn
```

### Parser usage

```posh
λ  cd .\parser\
λ  yarn crawl --culture en-us --currency USD --operating-system linux --region us-west
```

You can also use short names:

```posh
λ  yarn crawl -l en-us -c USD -o linux -r us-west
```

Arguments:

- `culture` any of the `option` `value` in the **Culture** `select`
  - **This will impact the formatting of the pricing**
- `currency` any of the `option` `value` in the **Currency** `select`
- `operating-system` any of the `option` `value` in the **OS/Software** `select`
- `region` any of the `option` `value` in the **Region** `select`

![OS and Region select](docs/assets/os-region.png)

In the footer:

![Culture and Currency select](docs/assets/culture-currency.png)

### Parser output

Writes `2` output files in the `out\` directory. One is a `CSV`, the other one is `JSON`. Both files contain the same data.

```text
.\out\vm-pricing_<region>_<operating-system>.csv
.\out\vm-pricing_<region>_<operating-system>.json
```

Fields:

- `Instance`
- `vCPU`
- `RAM`
- `Pay as You Go`
- `One Year Reserved`
- `Three Year Reserved`
- `Three Year Reserved With Azure Hybrid Benefit`

## Coster

Price `VMs` using the `JSON` pricing files generated by the `Parser`. The `Coster` will select the cheapest `VM` that has enough `CPU` cores and `RAM`.

### Coster pre-requisites

- `.NET Core SDK 2.2`

### Coster usage

You should paste the `JSON` pricing files generated by the `Parser` in the `Pricing\` folder.

In `Release` mode:

```posh
λ  cd .\coster\src\AzureVmCoster
λ  dotnet run --configuration Release -- <path>
```

In `Debug` mode

```posh
λ  cd .\coster\src\AzureVmCoster
λ  dotnet run --configuration Debug
Input file path:
```

You'll need to provide the `<path>` when prompted.

`<path>` should point to a `CSV` file with the following fields:

- `Region`
- `Name`
- `CPU` (`short`)
- `RAM` (in `GB`, a `decimal`)
- `Operating System`

The columns can be in any order and the `CSV` file can contain extra-columns. The `Region` and `Operating System` fields must match existing regions and supported operating systems in `Azure`.

### Coster output

The `Coster` will generate a `CSV` file in the `Out\` directory with the following fields:

- `Region`
- `Name`
- `Operating System`
- `Instance`
- `CPU`
- `RAM`
- `Pay as You Go`
- `One Year Reserved`
- `Three Year Reserved`
- `Three Year Reverved with Azure Hybrid Benefit`

[virtual-machines-pricing]: https://azure.microsoft.com/en-au/pricing/details/virtual-machines/windows/
[managed-disks-pricing]: https://azure.microsoft.com/en-us/pricing/details/managed-disks/
[bandwidth-pricing-details]: https://azure.microsoft.com/en-us/pricing/details/bandwidth/
